{% extends 'base.html.twig' %}

{% block title %}Gestion des Utilisateurs{% endblock %}

{% block body %}
    <div class="container mx-auto p-6">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">Gestion des Utilisateurs</h1>
            <!-- Trigger Add User Dialog -->
            <button
                    class="btn btn-primary"
                    onclick="openUserDialog('add', null)"
            >Ajouter un Utilisateur</button>
        </div>

        <!-- Search bar -->
        <div class="mb-4">
            <input
                    type="text"
                    placeholder="Rechercher..."
                    id="userSearch"
                    class="input input-bordered w-full max-w-md"
            />
        </div>

        <!-- Users table -->
        <div class="overflow-x-auto">
            <table class="table table-zebra w-full">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Email</th>
                    <th>Rôles</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="userTable">
                {% for user in ListUser %}
                    <tr>
                        <td>{{ user.id }}</td>
                        <td>{{ user.email }}</td>
                        <td>
                            {% for role in user.roles %}
                                <span class="badge badge-outline ml-1">{{ role }}</span>
                            {% endfor %}
                        </td>
                        <td>
                            <div class="flex space-x-2">
                                <!-- Trigger Edit User Dialog -->
                                {% if user.id != app.user.id %}
                                <button
                                        class="btn btn-sm btn-info"
                                        onclick="openUserDialog('edit', {{ user.id }})"
                                >Éditer</button>
                                <form
                                        method="post"
                                        action="{{ path('admin_user_delete', {'id': user.id}) }}"
                                        onsubmit="return confirm('Êtes-vous sûr ?');"
                                >
                                    <input
                                            type="hidden"
                                            name="_token"
                                            value="{{ csrf_token('delete' ~ user.id) }}"
                                    />
                                    <button type="submit" class="btn btn-sm btn-error">
                                        Supprimer
                                    </button>
                                </form>
                                {% else %}
                                    <span class="text-gray-500 italic">Actions non disponibles</span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="4" class="text-center">
                            Aucun utilisateur trouvé.
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- empty dialog -->
    <dialog id="modal-user" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box relative bg-base-100 shadow-2xl rounded-2xl p-8 max-w-lg w-full overflow-hidden">
            <!-- Close Button -->
            <button
                    type="button"
                    class="btn btn-sm btn-circle btn-ghost absolute top-4 right-4"
                    onclick="closeUserDialog()"
                    aria-label="Close modal"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 hover:text-gray-700 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <div class="flex items-center space-x-3 mb-6">
                <h3 id="modal-user-title" class="text-xl font-semibold text-gray-800">
                </h3>
            </div>
            <div id="user_form_container" class="space-y-4"></div>
        </div>
    </dialog>

    {% block javascripts %}
        {{ parent() }}
        <script>
            document.getElementById('userSearch').addEventListener('input', function(e) {
                const term = e.target.value.toLowerCase();
                document.querySelectorAll('#userTable tr').forEach(row => {
                    row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
                });
            });

            function openUserDialog(mode, userId) {
                const url = (mode === 'add')
                    ? '{{ path("admin_user_new") }}'
                    : `/admin/users/${userId}/edit`;

                fetch(url, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                    .then(r => r.text())
                    .then(html => {
                        // inject only the fragment into the container
                        document.getElementById('user_form_container').innerHTML = html;
                        document.getElementById('modal-user').showModal();
                    });
            }

            function closeUserDialog() {
                document.getElementById('modal-user').close();
                document.getElementById('user_form_container').innerHTML = '';
            }

        </script>
    {% endblock %}
{% endblock %}